// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =====================
// ENUMS
// =====================

enum TimeSlot {
  MORNING
  NOON
  AFTERNOON
  NIGHT
  BEFORE_SLEEP
}

enum IntakeStatus {
  PENDING // Upcoming, not yet due
  CONFIRMED // Taken on time
  LATE // Taken but late
  MISSED // Not taken (time passed without action)
  SKIPPED // User skipped intentionally
}

enum FrequencyType {
  DAILY
  INTERVAL
  SPECIFIC_DAYS
}

enum DosageUnit {
  MG
  ML
  IU
  TABLET
  CAPSULE
  DROPS
  TSP
  TBSP
}

enum IntervalUnit {
  DAYS
  WEEKS
  MONTHS
}

// =====================
// TABLES
// =====================

// User
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  settings          UserSettings?
  medications       Medication[]
  medicationLogs    MedicationLog[]
  emergencyContacts EmergencyContact[]

  @@map("users")
}

// User Settings/Preferences
model UserSettings {
  id                String  @id @default(uuid())
  userId            String  @unique @map("user_id")
  pushNotifications Boolean @default(true) @map("push_notifications")
  automatedCalls    Boolean @default(false) @map("automated_calls")
  darkMode          Boolean @default(false) @map("dark_mode")
  fcmToken          String? @map("fcm_token") // Firebase Cloud Messaging token

  // Default times for each slot (user can customize)
  morningTime     String @default("08:00") @map("morning_time")
  noonTime        String @default("12:00") @map("noon_time")
  afternoonTime   String @default("16:00") @map("afternoon_time")
  nightTime       String @default("20:00") @map("night_time")
  beforeSleepTime String @default("22:00") @map("before_sleep_time")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// Medication
model Medication {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  name          String
  dosage        String?
  unit          DosageUnit    @default(MG)
  instructions  String?
  notes         String?
  frequencyType FrequencyType @default(DAILY) @map("frequency_type")
  intervalValue Int           @default(1) @map("interval_value") // Every X days/weeks/months
  intervalUnit  IntervalUnit  @default(DAYS) @map("interval_unit")
  selectedDays  String[]      @default([]) @map("selected_days") // ["mon", "tue", "wed", "thu", "fri", "sat", "sun"]
  imageUrl      String?       @map("image_url") // Scanned prescription image
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedules      Schedule[]
  medicationLogs MedicationLog[]

  @@map("medications")
}

// Schedule - When to take each medication (intake times)
model Schedule {
  id           String   @id @default(uuid())
  medicationId String   @map("medication_id")
  time         String   // e.g., "08:00 AM" - stored as-is from frontend
  type         String   // e.g., "morning", "noon", "afternoon", "night", "before_sleep" - for UI color
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  medication     Medication      @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  medicationLogs MedicationLog[]

  @@map("schedules")
}

// Medication Log - History of intake
model MedicationLog {
  id            String       @id @default(uuid())
  userId        String       @map("user_id")
  medicationId  String       @map("medication_id")
  scheduleId    String?      @map("schedule_id") // Link to schedule template
  scheduledDate DateTime     @map("scheduled_date") // The date it was scheduled for
  scheduledTime String       @map("scheduled_time") // e.g., "08:00 AM"
  timeSlot      TimeSlot     @map("time_slot")
  status        IntakeStatus
  takenAt       DateTime?    @map("taken_at") // When actually taken (null if missed)
  createdAt     DateTime     @default(now()) @map("created_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  schedule   Schedule?  @relation(fields: [scheduleId], references: [id], onDelete: SetNull)

  @@map("medication_logs")
}

// Emergency Contact / Caregiver
model EmergencyContact {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String
  phone     String
  email     String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("emergency_contacts")
}
